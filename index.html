<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Old World Tech Tree</title>
    <script src="https://cdn.jsdelivr.net/npm/leader-line@1.0.7/leader-line.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c1810 0%, #4a3426 100%);
            color: #f4e4c1;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .main-container {
            flex: 1;
            padding: 20px;
            overflow: hidden;
            margin-right: 300px;
        }

        .sidebar {
            width: 300px;
            background: rgba(0, 0, 0, 0.5);
            border-left: 2px solid #8b6914;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            z-index: 100;
        }

        .sidebar h2 {
            color: #d4af37;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .nation-section {
            border-bottom: 2px solid #8b6914;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .nation-select {
            width: 100%;
            padding: 10px;
            background: rgba(50, 40, 30, 0.8);
            border: 2px solid #8b6914;
            border-radius: 5px;
            color: #f4e4c1;
            font-size: 1em;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nation-select:hover,
        .nation-select:focus {
            border-color: #d4af37;
            background: rgba(50, 40, 30, 1);
            outline: none;
        }

        .nation-select option {
            background: rgba(30, 25, 20, 0.95);
            color: #f4e4c1;
            padding: 8px;
        }

        .total-cost {
            background: linear-gradient(135deg, #6a4c93, #9b59b6);
            border: 1px solid #8b6914;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .total-laws {
            background: linear-gradient(135deg, #d4af37, #f4e27a);
            border: 1px solid #8b6914;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 15px;
            text-align: center;
            color: #2c1810;
            font-weight: bold;
            font-size: 1em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tech-order-list {
            flex: 1;
            overflow-y: auto;
        }

        .tech-order-item {
            background: rgba(50, 40, 30, 0.5);
            border: 1px solid #8b6914;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tech-order-number {
            color: #d4af37;
            font-weight: bold;
            margin-right: 10px;
        }

        .tech-order-name {
            flex: 1;
        }

        .tech-order-cost {
            color: #a09080;
            font-size: 0.9em;
        }

        .share-section {
            border-bottom: 2px solid #8b6914;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .share-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #2c5aa0, #4472c4);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            font-size: 1.2em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        .share-button:hover {
            background: linear-gradient(135deg, #4472c4, #5b87d4);
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        }

        .clear-button {
            width: 100%;
            padding: 8px;
            background: rgba(139, 30, 30, 0.5);
            border: 1px solid #8b3030;
            border-radius: 5px;
            color: #f4c4c4;
            font-weight: normal;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            font-size: 0.9em;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .clear-button:hover:not(.disabled) {
            background: rgba(139, 30, 30, 0.7);
            color: #fff;
        }

        .clear-button.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: rgba(139, 30, 30, 0.2);
            color: #999;
        }

        .shared-url {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #8b6914;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            word-break: break-all;
            font-size: 0.85em;
            display: none;
        }

        .shared-url.show {
            display: block;
        }

        .tech-tree-wrapper {
            position: relative;
            padding: 10px;
            width: 100%;
            overflow: hidden;
        }

        .tech-cost-headers {
            display: grid;
            grid-template-columns: repeat(8, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }

        .tech-cost-header {
            color: #d4af37;
            font-weight: bold;
            font-size: 0.85em;
            text-align: center;
            background: rgba(212, 175, 55, 0.1);
            padding: 6px 4px;
            border-radius: 4px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .tech-connection {
            pointer-events: none;
            z-index: 1;
        }

        .tech-tree {
            position: relative;
            display: grid;
            grid-template-columns: repeat(8, minmax(120px, 1fr));
            grid-template-rows: repeat(11, minmax(100px, auto));
            gap: 8px;
            z-index: 2;
            width: 100%;
        }

        .tech-node {
            background: linear-gradient(135deg, #3a2f1f, #2a1f0f);
            border: 2px solid #8b6914;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            position: relative;
            min-height: 100px;
        }

        .tech-node:hover {
            background: linear-gradient(135deg, #4a3f2f, #3a2f1f);
            border-color: #d4af37;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
            z-index: 10;
        }

        .tech-node.researched {
            background: linear-gradient(135deg, #2a4a2f, #1a3a1f);
            border-color: #5a8a3a;
        }

        .tech-node.available {
            background: linear-gradient(135deg, #4a3a1f, #3a2a0f);
            border-color: #b4a037;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .tech-order-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #d4af37;
            color: #1a1410;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .tech-name {
            font-weight: bold;
            font-size: 0.85em;
            color: #f4e4c1;
            margin-bottom: 4px;
            line-height: 1.2;
        }


        .tech-unlocks {
            font-size: 0.6em;
            color: #a09080;
            margin-top: 4px;
            max-height: 50px;
            overflow: hidden;
            line-height: 1.1;
        }

        .unlock-item {
            display: inline-block;
            margin-right: 6px;
            margin-bottom: 2px;
            white-space: normal;
            word-wrap: break-word;
            max-width: 100%;
        }

        .tooltip {
            position: absolute;
            background: rgba(20, 15, 10, 0.95);
            border: 2px solid #8b6914;
            border-radius: 6px;
            padding: 12px;
            min-width: 280px;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            pointer-events: none;
            word-wrap: break-word;
            white-space: normal;
        }

        .tooltip.show {
            display: block;
        }

        .tooltip h3 {
            color: #d4af37;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .tooltip p {
            font-size: 0.85em;
            line-height: 1.4;
            color: #f4e4c1;
            margin-bottom: 5px;
        }

        .tooltip .unlocks-list {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #4a3426;
        }

        .tooltip .unlocks-list h4 {
            color: #b4a037;
            font-size: 0.9em;
            margin-bottom: 4px;
        }

        .tooltip .unlocks-list ul {
            margin-left: 15px;
            font-size: 0.85em;
        }

        .bonus-tech-section {
            margin-top: 40px;
            padding: 20px;
            border-top: 2px solid #8b6914;
        }

        .bonus-tech-section h3 {
            color: #d4af37;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }

        .bonus-tech-grid {
            display: flex;
            flex-wrap: nowrap;
            gap: 12px;
            width: 100%;
            padding: 10px;
            overflow-x: auto;
        }

        .bonus-cost-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            flex-shrink: 0;
        }

        .bonus-cost-header {
            color: #d4af37;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-align: center;
            background: rgba(212, 175, 55, 0.1);
            padding: 4px 12px;
            border-radius: 4px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .bonus-cards-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .bonus-tech-node {
            background: linear-gradient(135deg, #4a3f2f, #3a2f1f);
            border: 2px solid #b4a037;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            min-height: 70px;
            width: 110px;
            opacity: 0.6;
        }

        .bonus-tech-node.available {
            opacity: 1;
            animation: bonusPulse 2s infinite;
        }

        .bonus-tech-node.researched {
            background: linear-gradient(135deg, #3a5a3f, #2a4a2f);
            border-color: #6ab36a;
            opacity: 1;
        }

        .bonus-tech-node:hover {
            background: linear-gradient(135deg, #5a4f3f, #4a3f2f);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
        }

        @keyframes bonusPulse {
            0%, 100% { 
                border-color: #b4a037;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            }
            50% { 
                border-color: #d4af37;
                box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
            }
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .tech-tree {
                grid-template-columns: repeat(8, minmax(110px, 1fr));
                gap: 6px;
            }
            
            .tech-cost-headers {
                grid-template-columns: repeat(8, minmax(110px, 1fr));
                gap: 6px;
            }
            
            .main-container {
                margin-right: 280px;
            }
            
            .sidebar {
                width: 280px;
            }
        }

        @media (max-width: 900px) {
            body {
                flex-direction: column;
            }
            
            .main-container {
                margin-right: 0;
                margin-bottom: 300px;
            }
            
            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 300px;
                max-height: 300px;
                overflow-y: auto;
            }
            
            .tech-tree {
                grid-template-columns: repeat(8, minmax(90px, 1fr));
                gap: 4px;
            }
            
            .tech-cost-headers {
                grid-template-columns: repeat(8, minmax(90px, 1fr));
                gap: 4px;
            }
        }

        .bonus-tech-name {
            font-weight: bold;
            font-size: 0.85em;
            color: #f4e4c1;
            margin-bottom: 3px;
        }

        .bonus-tech-cost {
            font-size: 0.75em;
            color: #d4af37;
        }

        .bonus-tech-parent {
            font-size: 0.7em;
            color: #a09080;
            margin-top: 3px;
        }

    </style>
</head>
<body>
    <div class="main-container">
        <div class="tech-tree-wrapper">
            <div class="tech-cost-headers">
                <div class="tech-cost-header">80 üß™</div>
                <div class="tech-cost-header">120 üß™</div>
                <div class="tech-cost-header">200 üß™</div>
                <div class="tech-cost-header">400 üß™</div>
                <div class="tech-cost-header">600 üß™</div>
                <div class="tech-cost-header">1000 üß™</div>
                <div class="tech-cost-header">1600 üß™</div>
                <div class="tech-cost-header">2000 üß™</div>
            </div>
            <div class="tech-tree" id="techTree"></div>
            
            <div class="bonus-tech-section">
                <h3>üíé Bonus Cards</h3>
                <div class="bonus-tech-grid" id="bonusTechGrid"></div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="share-section">
            <button class="share-button" onclick="shareBuild()">Share Build</button>
            <div class="shared-url" id="sharedUrl"></div>
        </div>
        
        <div class="nation-section">
            <h2>Nation</h2>
            <select class="nation-select" id="nationSelect" onchange="selectNation()">
                <option value="">No Nation</option>
                <option value="NATION_AKSUM">Aksum</option>
                <option value="NATION_ASSYRIA">Assyria</option>
                <option value="NATION_BABYLONIA">Babylonia</option>
                <option value="NATION_CARTHAGE">Carthage</option>
                <option value="NATION_EGYPT">Egypt</option>
                <option value="NATION_GREECE">Greece</option>
                <option value="NATION_HITTITE">Hittites</option>
                <option value="NATION_KUSH">Kush</option>
                <option value="NATION_PERSIA">Persia</option>
                <option value="NATION_ROME">Rome</option>
            </select>
        </div>
        
        <h2>Research Order</h2>
        <div class="total-cost" id="totalCost">Total Cost: 0</div>
        <div class="total-laws" id="totalLaws">Laws Available: 0</div>
        <div class="tech-order-list" id="techOrderList"></div>
        
        <button class="clear-button" onclick="clearBuild()">Clear All</button>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Complete tech tree data from game files with correct prerequisites and unlocks
        const techData = {
            techs: [
                // Column 0
                { id: "TECH_IRONWORKING", name: "Ironworking", cost: 80, column: 0, row: 2, prereqs: [], unlocks: { units: ["Warrior"], improvements: [], laws: [], projects: [] } },
                { id: "TECH_STONECUTTING", name: "Stonecutting", cost: 80, column: 0, row: 5, prereqs: [], unlocks: { units: [], improvements: ["Fort", "Quarry"], laws: [], projects: [] } },
                { id: "TECH_TRAPPING", name: "Trapping", cost: 80, column: 0, row: 7, prereqs: [], unlocks: { units: ["Slinger"], improvements: ["Camp"], laws: [], projects: [] } },
                { id: "TECH_DIVINATION", name: "Divination", cost: 80, column: 0, row: 8, prereqs: [], unlocks: { units: [], improvements: ["Shrine"], laws: [], projects: [] } },
                { id: "TECH_ADMINISTRATION", name: "Administration", cost: 80, column: 0, row: 10, prereqs: [], unlocks: { units: [], improvements: ["Granary"], laws: [], projects: ["Treasury"] } },
                
                // Column 1
                { id: "TECH_LABOR_FORCE", name: "Labor Force", cost: 120, column: 1, row: 1, prereqs: ["TECH_IRONWORKING"], unlocks: { units: [], improvements: [], laws: ["Slavery/Freedom"], projects: [] } },
                { id: "TECH_HUSBANDRY", name: "Husbandry", cost: 120, column: 1, row: 3, prereqs: ["TECH_IRONWORKING"], unlocks: { units: [], improvements: ["Pasture"], laws: [], projects: [] } },
                { id: "TECH_DRAMA", name: "Drama", cost: 120, column: 1, row: 4, prereqs: ["TECH_STONECUTTING"], unlocks: { units: [], improvements: ["Odeon"], laws: [], projects: [] } },
                { id: "TECH_POLIS", name: "Polis", cost: 120, column: 1, row: 5, prereqs: ["TECH_STONECUTTING"], unlocks: { units: [], improvements: ["Hamlet"], laws: [], projects: ["Walls"] } },
                { id: "TECH_MILITARY_DRILL", name: "Military Drill", cost: 120, column: 1, row: 7, prereqs: ["TECH_TRAPPING"], unlocks: { units: [], improvements: ["Barracks"], laws: [], projects: [] } },
                { id: "TECH_ARISTOCRACY", name: "Aristocracy", cost: 120, column: 1, row: 8, prereqs: ["TECH_DIVINATION"], unlocks: { units: [], improvements: ["Kushite Pyramids"], laws: ["Centralization/Vassalage"], projects: [] } },
                { id: "TECH_RHETORIC", name: "Rhetoric", cost: 120, column: 1, row: 10, prereqs: ["TECH_ADMINISTRATION"], unlocks: { units: [], improvements: [], laws: ["Epics/Exploration"], projects: ["Forum"] } },
                
                // Column 2
                { id: "TECH_NAVIGATION", name: "Navigation", cost: 200, column: 2, row: 0, prereqs: ["TECH_LABOR_FORCE"], unlocks: { units: ["Bireme"], improvements: [], laws: ["Colonies/Serfdom"], projects: [] } },
                { id: "TECH_PHALANX", name: "Phalanx", cost: 200, column: 2, row: 2, prereqs: ["TECH_LABOR_FORCE"], unlocks: { units: ["Spearman"], improvements: [], laws: [], projects: [] } },
                { id: "TECH_SPOKED_WHEEL", name: "Spoked Wheel", cost: 200, column: 2, row: 3, prereqs: ["TECH_HUSBANDRY"], unlocks: { units: ["Chariot"], improvements: [], laws: [], projects: [] } },
                { id: "TECH_FORESTRY", name: "Forestry", cost: 200, column: 2, row: 5, prereqs: ["TECH_POLIS"], unlocks: { units: [], improvements: ["Lumbermill"], laws: [], projects: [] } },
                { id: "TECH_STEEL", name: "Steel", cost: 200, column: 2, row: 7, prereqs: ["TECH_IRONWORKING", "TECH_MILITARY_DRILL"], unlocks: { units: ["Axeman"], improvements: [], laws: [], projects: [] } },
                { id: "TECH_SOVEREIGNTY", name: "Sovereignty", cost: 200, column: 2, row: 9, prereqs: ["TECH_ARISTOCRACY", "TECH_RHETORIC"], unlocks: { units: [], improvements: [], laws: ["Tyranny/Constitution"], projects: [] } },
                { id: "TECH_METAPHYSICS", name: "Metaphysics", cost: 200, column: 2, row: 10, prereqs: ["TECH_RHETORIC"], unlocks: { units: [], improvements: [], laws: [], projects: ["Archive"] } },
                
                // Column 3
                { id: "TECH_COINAGE", name: "Coinage", cost: 400, column: 3, row: 0, prereqs: ["TECH_NAVIGATION"], unlocks: { units: [], improvements: ["Market"], laws: [], projects: [] } },
                { id: "TECH_CITIZENSHIP", name: "Citizenship", cost: 400, column: 3, row: 2, prereqs: ["TECH_PHALANX"], unlocks: { units: [], improvements: ["Courthouse"], laws: ["Divine Rule/Legal Code"], projects: [] } },
                { id: "TECH_PORTCULLIS", name: "Portcullis", cost: 400, column: 3, row: 3, prereqs: ["TECH_SPOKED_WHEEL"], unlocks: { units: [], improvements: [], laws: [], projects: ["Moat"] } },
                { id: "TECH_ARCHITECTURE", name: "Architecture", cost: 400, column: 3, row: 4, prereqs: ["TECH_DRAMA"], unlocks: { units: [], improvements: ["Baths"], laws: ["Philosophy/Engineering"], projects: [] } },
                { id: "TECH_LAND_CONSOLIDATION", name: "Land Consolidation", cost: 400, column: 3, row: 5, prereqs: ["TECH_FORESTRY"], unlocks: { units: ["Camel Archer"], improvements: ["Grove"], laws: [], projects: [] } },
                { id: "TECH_COMPOSITE_BOW", name: "Composite Bow", cost: 400, column: 3, row: 6, prereqs: ["TECH_MILITARY_DRILL"], unlocks: { units: [], improvements: ["Range"], laws: [], projects: [] } },
                { id: "TECH_MONASTICISM", name: "Monasticism", cost: 400, column: 3, row: 8, prereqs: ["TECH_ARISTOCRACY"], unlocks: { units: [], improvements: ["Monastery"], laws: ["Monotheism/Polytheism"], projects: [] } },
                { id: "TECH_MACHINERY", name: "Machinery", cost: 400, column: 3, row: 9, prereqs: ["TECH_SOVEREIGNTY"], unlocks: { units: ["Onager"], improvements: [], laws: [], projects: [] } },
                
                // Column 4
                { id: "TECH_SCHOLARSHIP", name: "Scholarship", cost: 600, column: 4, row: 1, prereqs: ["TECH_CITIZENSHIP"], unlocks: { units: [], improvements: ["Library"], laws: [], projects: [] } },
                { id: "TECH_STIRRUPS", name: "Stirrups", cost: 600, column: 4, row: 3, prereqs: ["TECH_PORTCULLIS"], unlocks: { units: ["Horseman", "Horse Archer"], improvements: [], laws: [], projects: [] } },
                { id: "TECH_VAULTING", name: "Vaulting", cost: 600, column: 4, row: 4, prereqs: ["TECH_ARCHITECTURE"], unlocks: { units: [], improvements: ["Cathedral"], laws: ["Iconography/Calligraphy"], projects: [] } },
                { id: "TECH_MANOR", name: "Manor", cost: 600, column: 4, row: 5, prereqs: ["TECH_LAND_CONSOLIDATION", "TECH_COMPOSITE_BOW"], unlocks: { units: ["Conscript"], improvements: [], laws: ["Professional Army/Volunteers"], projects: [] } },
                { id: "TECH_BATTLELINE", name: "Battle Line", cost: 600, column: 4, row: 7, prereqs: ["TECH_PHALANX", "TECH_STEEL"], unlocks: { units: ["Maceman"], improvements: [], laws: [], projects: [] } },
                { id: "TECH_DOCTRINE", name: "Doctrine", cost: 600, column: 4, row: 8, prereqs: ["TECH_MONASTICISM"], unlocks: { units: [], improvements: ["Temple"], laws: ["Tolerance/Orthodoxy"], projects: [] } },
                { id: "TECH_HYDRAULICS", name: "Hydraulics", cost: 600, column: 4, row: 9, prereqs: ["TECH_MACHINERY"], unlocks: { units: ["Ballista"], improvements: ["Mill"], laws: [], projects: [] } },
                { id: "TECH_CARTOGRAPHY", name: "Cartography", cost: 600, column: 4, row: 10, prereqs: ["TECH_NAVIGATION", "TECH_METAPHYSICS"], unlocks: { units: [], improvements: ["Harbor"], laws: [], projects: [] } },
                
                // Column 5
                { id: "TECH_LATEEN_SAIL", name: "Lateen Sail", cost: 1000, column: 5, row: 0, prereqs: ["TECH_COINAGE", "TECH_CARTOGRAPHY"], unlocks: { units: ["Dromon"], improvements: [], laws: ["Autarky/Trade League"], projects: [] } },
                { id: "TECH_JURISPRUDENCE", name: "Jurisprudence", cost: 1000, column: 5, row: 1, prereqs: ["TECH_SCHOLARSHIP"], unlocks: { units: [], improvements: [], laws: ["Guilds/Elites"], projects: [] } },
                { id: "TECH_MARTIAL_CODE", name: "Martial Code", cost: 1000, column: 5, row: 2, prereqs: ["TECH_STIRRUPS", "TECH_CITIZENSHIP"], unlocks: { units: [], improvements: [], laws: ["Pilgrimage/Holy War"], projects: ["Towers"] } },
                { id: "TECH_BODKIN_ARROW", name: "Bodkin Arrow", cost: 1000, column: 5, row: 5, prereqs: ["TECH_MANOR"], unlocks: { units: ["Longbowman"], improvements: [], laws: [], projects: [] } },
                { id: "TECH_WINDLASS", name: "Windlass", cost: 1000, column: 5, row: 9, prereqs: ["TECH_MANOR", "TECH_HYDRAULICS"], unlocks: { units: ["Crossbowman"], improvements: [], laws: [], projects: [] } },
                
                // Column 6
                { id: "TECH_FISCAL_POLICY", name: "Fiscal Policy", cost: 1600, column: 6, row: 1, prereqs: ["TECH_LATEEN_SAIL", "TECH_JURISPRUDENCE"], unlocks: { units: [], improvements: [], laws: ["Coin Debasement/Monetary Reform"], projects: [] } },
                { id: "TECH_BARDING", name: "Barding", cost: 1600, column: 6, row: 2, prereqs: ["TECH_BATTLELINE", "TECH_MARTIAL_CODE"], unlocks: { units: ["Cataphract"], improvements: [], laws: [], projects: [] } },
                { id: "TECH_COHORTS", name: "Cohorts", cost: 1600, column: 6, row: 6, prereqs: ["TECH_MANOR", "TECH_BATTLELINE"], unlocks: { units: ["Swordsman"], improvements: [], laws: [], projects: [] } },
                { id: "TECH_INFANTRY_SQUARE", name: "Infantry Square", cost: 1600, column: 6, row: 7, prereqs: ["TECH_BATTLELINE"], unlocks: { units: ["Pikeman"], improvements: [], laws: [], projects: [] } },
                { id: "TECH_CHAIN_DRIVE", name: "Chain Drive", cost: 1600, column: 6, row: 9, prereqs: ["TECH_WINDLASS"], unlocks: { units: ["Polybolos"], improvements: [], laws: [], projects: [] } },
                { id: "TECH_BALLISTICS", name: "Ballistics", cost: 1600, column: 6, row: 10, prereqs: ["TECH_CARTOGRAPHY", "TECH_HYDRAULICS"], unlocks: { units: ["Mangonel"], improvements: [], laws: [], projects: [] } },
                
                // Column 7 - Victory Techs
                { id: "TECH_ECONOMIC_REFORM", name: "Economic Reform", cost: 2000, column: 7, row: 1, prereqs: ["TECH_FISCAL_POLICY"], unlocks: { units: [], improvements: [], laws: [], projects: [] } },
                { id: "TECH_MILITARY_PRESTIGE", name: "Military Prestige", cost: 2000, column: 7, row: 5, prereqs: ["TECH_BARDING", "TECH_BODKIN_ARROW", "TECH_COHORTS"], unlocks: { units: [], improvements: [], laws: [], projects: [] } },
                { id: "TECH_INDUSTRIAL_PROGRESS", name: "Industrial Progress", cost: 2000, column: 7, row: 9, prereqs: ["TECH_CHAIN_DRIVE", "TECH_BALLISTICS"], unlocks: { units: [], improvements: [], laws: [], projects: [] } }
            ],
            bonusTechs: [
                { id: "TECH_STONECUTTING_BONUS_STONE", name: "Stone Boost", cost: 40, parent: "TECH_STONECUTTING", bonus: "+200 Stone" },
                { id: "TECH_ADMINISTRATION_BONUS_WORKER", name: "Free Worker", cost: 40, parent: "TECH_ADMINISTRATION", bonus: "+1 Worker" },
                { id: "TECH_HUSBANDRY_BONUS_FOOD", name: "Food Boost", cost: 60, parent: "TECH_HUSBANDRY", bonus: "+200 Food" },
                { id: "TECH_DRAMA_BONUS_SETTLER", name: "Free Settler", cost: 60, parent: "TECH_DRAMA", bonus: "+1 Settler" },
                { id: "TECH_ARISTOCRACY_BONUS_BORDERS", name: "Border Boost", cost: 60, parent: "TECH_ARISTOCRACY", bonus: "Border Growth" },
                { id: "TECH_NAVIGATION_BONUS_BIREME", name: "Free Bireme", cost: 100, parent: "TECH_STEEL", bonus: "+1 Bireme" },
                { id: "TECH_STEEL_BONUS_TRAINING", name: "Training Boost", cost: 100, parent: "TECH_STEEL", bonus: "Unit Training" },
                { id: "TECH_PHALANX_BONUS_ORDERS", name: "Orders Boost", cost: 100, parent: "TECH_PHALANX", bonus: "+20 Orders" },
                { id: "TECH_SPOKED_WHEEL_BONUS_CHARIOT", name: "Free Chariot", cost: 100, parent: "TECH_SOVEREIGNTY", bonus: "+1 Chariot" },
                { id: "TECH_SOVEREIGNITY_BONUS_CIVICS", name: "Civics Boost", cost: 100, parent: "TECH_SOVEREIGNTY", bonus: "Civic Points" },
                { id: "TECH_FORESTRY_BONUS_SCIENTIST", name: "Free Scientist", cost: 100, parent: "TECH_METAPHYSICS", bonus: "Free Scientist" },
                { id: "TECH_COINAGE_BONUS_MONEY", name: "Money Boost", cost: 200, parent: "TECH_COINAGE", bonus: "+200 Money" },
                { id: "TECH_CITIZENSHIP_BONUS_MINISTER", name: "Free Minister", cost: 200, parent: "TECH_CITIZENSHIP", bonus: "+1 Minister" },
                { id: "TECH_PORTCULLIS_BONUS_MACEMAN", name: "Free Maceman", cost: 200, parent: "TECH_PORTCULLIS", bonus: "+1 Maceman" },
                { id: "TECH_MACHINERY_BONUS_ONAGER", name: "Free Onager", cost: 200, parent: "TECH_PORTCULLIS", bonus: "Free Onager" },
                { id: "TECH_LAND_CONSOLIDATION_BONUS_CAMEL_ARCHER", name: "Free Camel Archer", cost: 200, parent: "TECH_MONASTICISM", bonus: "Free Camel Archer" },
                { id: "TECH_LAND_CONSOLIDATION_BONUS_WAR_ELEPHANT", name: "Free War Elephant", cost: 200, parent: "TECH_MACHINERY", bonus: "Free War Elephant" },
                { id: "TECH_MANOR_BONUS_GOODS", name: "Goods Bonus", cost: 200, parent: "TECH_MACHINERY", bonus: "Luxury Goods" },
                { id: "TECH_COMPOSITE_BOW_BONUS_ARCHER", name: "Free Archer", cost: 100, parent: "TECH_FORESTRY", bonus: "+1 Archer" },
                { id: "TECH_SCHOLARSHIP_BONUS_SCIENTIST", name: "Free Scientist", cost: 400, parent: "TECH_SCHOLARSHIP", bonus: "Free Scientist" },
                { id: "TECH_STIRRUPS_BONUS_HORSEMAN", name: "Free Horseman", cost: 200, parent: "TECH_LAND_CONSOLIDATION", bonus: "Free Horseman" },
                { id: "TECH_STIRRUPS_BONUS_HORSE_ARCHER", name: "Free Horse Archer", cost: 200, parent: "TECH_LAND_CONSOLIDATION", bonus: "Free Horse Archer" },
                { id: "TECH_BATTLELINE_BONUS_SOLDIER", name: "Free Court Soldier", cost: 400, parent: "TECH_BATTLELINE", bonus: "Free Court Soldier" },
                { id: "TECH_HYDRAULICS_BONUS_BALLISTA", name: "Free Ballista", cost: 200, parent: "TECH_COMPOSITE_BOW", bonus: "Free Ballista" },
                { id: "TECH_JURISPRUDENCE_BONUS_MINISTER", name: "Free Minister", cost: 600, parent: "TECH_JURISPRUDENCE", bonus: "Free Minister" },
                { id: "TECH_VAULTING_BONUS_HAPPINESS", name: "Happiness Boost", cost: 400, parent: "TECH_VAULTING", bonus: "Happiness Boost" },
                { id: "TECH_BODKIN_ARROW_BONUS_LONGBOWMAN", name: "Free Longbowman", cost: 400, parent: "TECH_MANOR", bonus: "+2 Longbowman" },
                { id: "TECH_WINDLASS_BONUS_CROSSBOWMAN", name: "Free Crossbowman", cost: 400, parent: "TECH_HYDRAULICS", bonus: "+2 Crossbowman" },
                { id: "TECH_FISCAL_POLICY_BONUS_MERCHANT", name: "Free Merchant", cost: 1000, parent: "TECH_FISCAL_POLICY", bonus: "Free Merchant" },
                { id: "TECH_INFANTRY_SQUARE_BONUS_SOLDIER", name: "Free Court Soldier", cost: 1000, parent: "TECH_INFANTRY_SQUARE", bonus: "Free Court Soldier" },
                { id: "TECH_CHAIN_DRIVE_BONUS_MERCHANT", name: "Free Merchant", cost: 1000, parent: "TECH_CHAIN_DRIVE", bonus: "Free Merchant" },
                
                // Nation-specific bonus techs
                { id: "TECH_BATTERING_RAM_BONUS", name: "Free Battering Ram", cost: 100, parent: "TECH_SPOKED_WHEEL", bonus: "+1 Battering Ram", nation: "NATION_ASSYRIA" },
                { id: "TECH_SIEGE_TOWER_BONUS", name: "Free Siege Tower", cost: 600, parent: "TECH_WINDLASS", bonus: "+2 Siege Tower", nation: "NATION_ASSYRIA" },
                { id: "TECH_AKKADIAN_ARCHER_BONUS", name: "Free Akkadian Archer", cost: 100, parent: "TECH_FORESTRY", bonus: "+1 Akkadian Archer", nation: "NATION_BABYLONIA" },
                { id: "TECH_CIMMERIAN_ARCHER_BONUS", name: "Free Cimmerian Archer", cost: 600, parent: "TECH_BODKIN_ARROW", bonus: "+2 Cimmerian Archer", nation: "NATION_BABYLONIA" },
                { id: "TECH_AFRICAN_ELEPHANT_BONUS", name: "Free African Elephant", cost: 100, parent: "TECH_STEEL", bonus: "+1 African Elephant", nation: "NATION_CARTHAGE" },
                { id: "TECH_TURRETED_ELEPHANT_BONUS", name: "Free Turreted Elephant", cost: 600, parent: "TECH_MARTIAL_CODE", bonus: "+2 Turreted Elephant", nation: "NATION_CARTHAGE" },
                { id: "TECH_LIGHT_CHARIOT_BONUS", name: "Free Light Chariot", cost: 100, parent: "TECH_SPOKED_WHEEL", bonus: "+1 Light Chariot", nation: "NATION_EGYPT" },
                { id: "TECH_MOUNTED_LANCER_BONUS", name: "Free Mounted Lancer", cost: 600, parent: "TECH_MARTIAL_CODE", bonus: "+2 Mounted Lancer", nation: "NATION_EGYPT" },
                { id: "TECH_HOPLITE_BONUS", name: "Free Hoplite", cost: 100, parent: "TECH_PHALANX", bonus: "+1 Hoplite", nation: "NATION_GREECE" },
                { id: "TECH_PHALANGITE_BONUS", name: "Free Phalangite", cost: 600, parent: "TECH_MARTIAL_CODE", bonus: "+2 Phalangite", nation: "NATION_GREECE" },
                { id: "TECH_HITTITE_CHARIOT_1_BONUS", name: "Free Hittite Chariot", cost: 100, parent: "TECH_SPOKED_WHEEL", bonus: "+1 Hittite Chariot", nation: "NATION_HITTITE" },
                { id: "TECH_HITTITE_CHARIOT_2_BONUS", name: "Free Three-Man Chariot", cost: 600, parent: "TECH_MARTIAL_CODE", bonus: "+2 Three-Man Chariot", nation: "NATION_HITTITE" },
                { id: "TECH_MEDJAY_ARCHER_BONUS", name: "Free Medjay Archer", cost: 100, parent: "TECH_FORESTRY", bonus: "+1 Medjay Archer", nation: "NATION_KUSH" },
                { id: "TECH_BEJA_ARCHER_BONUS", name: "Free Beja Archer", cost: 600, parent: "TECH_BODKIN_ARROW", bonus: "+2 Beja Archer", nation: "NATION_KUSH" },
                { id: "TECH_PALTON_CAVALRY_BONUS", name: "Free Palton Cavalry", cost: 100, parent: "TECH_FORESTRY", bonus: "+1 Palton Cavalry", nation: "NATION_PERSIA" },
                { id: "TECH_CATAPHRACT_ARCHER_BONUS", name: "Free Cataphract Archer", cost: 600, parent: "TECH_WINDLASS", bonus: "+2 Cataphract Archer", nation: "NATION_PERSIA" },
                { id: "TECH_HASTATUS_BONUS", name: "Free Hastatus", cost: 100, parent: "TECH_STEEL", bonus: "+1 Hastatus", nation: "NATION_ROME" },
                { id: "TECH_LEGIONARY_BONUS", name: "Free Legionary", cost: 600, parent: "TECH_MARTIAL_CODE", bonus: "+2 Legionary", nation: "NATION_ROME" },
                { id: "TECH_DMT_WARRIOR_BONUS", name: "Free Dmt Warrior", cost: 100, parent: "TECH_STEEL", bonus: "+1 Dmt Warrior", nation: "NATION_AKSUM" },
                { id: "TECH_SHOTELAI_BONUS", name: "Free Shotelai", cost: 600, parent: "TECH_MARTIAL_CODE", bonus: "+2 Shotelai", nation: "NATION_AKSUM" }
            ]
        };

        let researchedTechs = [];
        let researchOrder = [];
        let researchedBonusTechs = [];
        let selectedNation = '';

        // Nation lookup array for URL indices
        const nationLookup = [
            "NATION_AKSUM",
            "NATION_ASSYRIA", 
            "NATION_BABYLONIA",
            "NATION_CARTHAGE",
            "NATION_EGYPT",
            "NATION_GREECE",
            "NATION_HITTITE",
            "NATION_KUSH",
            "NATION_PERSIA",
            "NATION_ROME"
        ];

        const nationData = {
            startingTechs: {
                "NATION_AKSUM": ["TECH_TRAPPING", "TECH_LABOR_FORCE", "TECH_ADMINISTRATION"],
                "NATION_ASSYRIA": ["TECH_TRAPPING", "TECH_ADMINISTRATION", "TECH_MILITARY_DRILL"],
                "NATION_BABYLONIA": ["TECH_TRAPPING", "TECH_ADMINISTRATION", "TECH_RHETORIC"],
                "NATION_CARTHAGE": ["TECH_TRAPPING", "TECH_DIVINATION", "TECH_ARISTOCRACY"],
                "NATION_EGYPT": ["TECH_IRONWORKING", "TECH_STONECUTTING", "TECH_LABOR_FORCE"],
                "NATION_GREECE": ["TECH_IRONWORKING", "TECH_STONECUTTING", "TECH_DRAMA"],
                "NATION_HITTITE": ["TECH_IRONWORKING", "TECH_HUSBANDRY", "TECH_ADMINISTRATION"],
                "NATION_KUSH": ["TECH_TRAPPING", "TECH_STONECUTTING", "TECH_DIVINATION"],
                "NATION_PERSIA": ["TECH_IRONWORKING", "TECH_TRAPPING", "TECH_HUSBANDRY"],
                "NATION_ROME": ["TECH_IRONWORKING", "TECH_STONECUTTING", "TECH_POLIS"]
            },
            nationSpecificBonuses: {
                "NATION_AKSUM": ["TECH_DMT_WARRIOR_BONUS", "TECH_SHOTELAI_BONUS"],
                "NATION_ASSYRIA": ["TECH_BATTERING_RAM_BONUS", "TECH_SIEGE_TOWER_BONUS"],
                "NATION_BABYLONIA": ["TECH_AKKADIAN_ARCHER_BONUS", "TECH_CIMMERIAN_ARCHER_BONUS"],
                "NATION_CARTHAGE": ["TECH_AFRICAN_ELEPHANT_BONUS", "TECH_TURRETED_ELEPHANT_BONUS"],
                "NATION_EGYPT": ["TECH_LIGHT_CHARIOT_BONUS", "TECH_MOUNTED_LANCER_BONUS"],
                "NATION_GREECE": ["TECH_HOPLITE_BONUS", "TECH_PHALANGITE_BONUS"],
                "NATION_HITTITE": ["TECH_HITTITE_CHARIOT_1_BONUS", "TECH_HITTITE_CHARIOT_2_BONUS"],
                "NATION_KUSH": ["TECH_MEDJAY_ARCHER_BONUS", "TECH_BEJA_ARCHER_BONUS"],
                "NATION_PERSIA": ["TECH_PALTON_CAVALRY_BONUS", "TECH_CATAPHRACT_ARCHER_BONUS"],
                "NATION_ROME": ["TECH_HASTATUS_BONUS", "TECH_LEGIONARY_BONUS"]
            }
        };

        function initializeTechTree() {
            const techTree = document.getElementById('techTree');
            techTree.innerHTML = '';
            
            // Add tech nodes
            techData.techs.forEach(tech => {
                const node = document.createElement('div');
                node.className = 'tech-node';
                node.id = tech.id;
                node.style.gridColumn = tech.column + 1;
                node.style.gridRow = tech.row + 1;
                
                // Build unlocks display with emojis
                let unlocksHtml = '';
                const allUnlocks = [];
                
                if (tech.unlocks.units?.length > 0) {
                    tech.unlocks.units.forEach(unit => {
                        allUnlocks.push(`<span class="unlock-item">‚öîÔ∏è${unit}</span>`);
                    });
                }
                if (tech.unlocks.improvements?.length > 0) {
                    tech.unlocks.improvements.forEach(improvement => {
                        allUnlocks.push(`<span class="unlock-item">üèóÔ∏è${improvement}</span>`);
                    });
                }
                if (tech.unlocks.laws?.length > 0) {
                    tech.unlocks.laws.forEach(law => {
                        allUnlocks.push(`<span class="unlock-item">‚öñÔ∏è${law}</span>`);
                    });
                }
                if (tech.unlocks.projects?.length > 0) {
                    tech.unlocks.projects.forEach(project => {
                        allUnlocks.push(`<span class="unlock-item">üèõÔ∏è${project}</span>`);
                    });
                }
                
                // Check if this tech has bonus techs available and add to unlocks
                const bonusTechs = techData.bonusTechs.filter(bonus => bonus.parent === tech.id);
                if (bonusTechs.length > 0) {
                    bonusTechs.forEach(bonusTech => {
                        // Use person emoji for courtiers, diamond for others
                        const isCourtier = bonusTech.name.includes('Minister') || 
                                         bonusTech.name.includes('Scientist') || 
                                         bonusTech.name.includes('Court Soldier') ||
                                         bonusTech.name.includes('Merchant');
                        const emoji = isCourtier ? 'üë§' : 'üíé';
                        allUnlocks.push(`<span class="unlock-item">${emoji}${bonusTech.name}</span>`);
                    });
                }
                
                if (allUnlocks.length > 0) {
                    unlocksHtml = `<div class="tech-unlocks">${allUnlocks.join('')}</div>`;
                }
                
                node.innerHTML = `
                    <div class="tech-name">${tech.name}</div>
                    ${unlocksHtml}
                `;
                
                node.addEventListener('click', () => toggleResearch(tech.id));
                node.addEventListener('mouseenter', (e) => showTooltip(e, tech));
                node.addEventListener('mouseleave', hideTooltip);
                
                techTree.appendChild(node);
            });
            
            // Initialize bonus tech section
            initializeBonusTechs();
            
            // Load from URL if present
            loadFromUrl();
            
            updateTechStates();
            drawConnections();
        }

        function initializeBonusTechs() {
            const bonusTechGrid = document.getElementById('bonusTechGrid');
            bonusTechGrid.innerHTML = '';
            
            // Filter bonus techs based on selected nation
            const availableBonusTechs = techData.bonusTechs.filter(bonusTech => {
                // Show general bonus techs (no nation property)
                if (!bonusTech.nation) return true;
                // Show nation-specific bonus techs only if nation is selected and matches
                return selectedNation && bonusTech.nation === selectedNation;
            });
            
            // Group bonus techs by cost
            const costGroups = {};
            availableBonusTechs.forEach(bonusTech => {
                if (!costGroups[bonusTech.cost]) {
                    costGroups[bonusTech.cost] = [];
                }
                costGroups[bonusTech.cost].push(bonusTech);
            });
            
            // Sort cost groups by cost
            const sortedCosts = Object.keys(costGroups).map(Number).sort((a, b) => a - b);
            
            sortedCosts.forEach(cost => {
                // Create cost group container
                const costGroup = document.createElement('div');
                costGroup.className = 'bonus-cost-group';
                
                // Add cost header  
                const costHeader = document.createElement('div');
                costHeader.className = 'bonus-cost-header';
                costHeader.textContent = `${cost} üß™`;
                costGroup.appendChild(costHeader);
                
                // Add cards column
                const cardsColumn = document.createElement('div');
                cardsColumn.className = 'bonus-cards-column';
                
                costGroups[cost].forEach(bonusTech => {
                    const node = document.createElement('div');
                    node.className = 'bonus-tech-node';
                    node.id = bonusTech.id;
                    
                    node.innerHTML = `
                        <div class="bonus-tech-name">${bonusTech.name}</div>
                        <div class="bonus-tech-parent">${bonusTech.bonus}</div>
                    `;
                    
                    node.addEventListener('click', () => toggleBonusResearch(bonusTech.id));
                    node.addEventListener('mouseenter', (e) => showBonusTooltip(e, bonusTech));
                    node.addEventListener('mouseleave', hideTooltip);
                    
                    cardsColumn.appendChild(node);
                });
                
                costGroup.appendChild(cardsColumn);
                bonusTechGrid.appendChild(costGroup);
            });
            
            updateBonusTechStates();
        }

        function toggleBonusResearch(bonusTechId) {
            const bonusTech = techData.bonusTechs.find(t => t.id === bonusTechId);
            if (!bonusTech) return;

            const index = researchedBonusTechs.indexOf(bonusTechId);
            if (index > -1) {
                // Remove bonus tech
                researchedBonusTechs.splice(index, 1);
            } else {
                // Add the parent tech and all its prerequisites first
                if (!researchedTechs.includes(bonusTech.parent)) {
                    // Add prerequisites of the parent tech
                    const prereqsToAdd = getAllPrerequisites(bonusTech.parent);
                    prereqsToAdd.forEach(prereqId => {
                        if (!researchedTechs.includes(prereqId)) {
                            researchedTechs.push(prereqId);
                            researchOrder.push(Date.now());
                        }
                    });
                    
                    // Add the parent tech itself
                    researchedTechs.push(bonusTech.parent);
                    researchOrder.push(Date.now());
                }
                
                // Now add the bonus tech
                researchedBonusTechs.push(bonusTechId);
            }
            
            updateTechStates(); // Update main tech states too since we may have added main techs
            updateBonusTechStates();
            updateOrderList();
            drawConnections(); // Redraw connections since main techs may have changed
        }

        function updateBonusTechStates() {
            // Filter bonus techs based on selected nation - same logic as initializeBonusTechs
            const availableBonusTechs = techData.bonusTechs.filter(bonusTech => {
                // Show general bonus techs (no nation property)
                if (!bonusTech.nation) return true;
                // Show nation-specific bonus techs only if nation is selected and matches
                return selectedNation && bonusTech.nation === selectedNation;
            });
            
            availableBonusTechs.forEach(bonusTech => {
                const node = document.getElementById(bonusTech.id);
                if (node) {
                    node.classList.remove('available', 'researched');
                    
                    // Remove existing order badge
                    const existingBadge = node.querySelector('.tech-order-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                    
                    if (researchedBonusTechs.includes(bonusTech.id)) {
                        node.classList.add('researched');
                        
                        // Add order badge - calculate position in overall research order
                        const allResearched = [...researchedTechs, ...researchedBonusTechs];
                        const overallIndex = allResearched.indexOf(bonusTech.id);
                        if (overallIndex > -1) {
                            const badge = document.createElement('div');
                            badge.className = 'tech-order-badge';
                            badge.textContent = overallIndex + 1;
                            node.appendChild(badge);
                        }
                    } else if (researchedTechs.includes(bonusTech.parent)) {
                        node.classList.add('available');
                    }
                }
            });
        }

        function showBonusTooltip(event, bonusTech) {
            const tooltip = document.getElementById('tooltip');
            const parentTech = techData.techs.find(t => t.id === bonusTech.parent);
            const parentName = parentTech ? parentTech.name : bonusTech.parent;
            
            tooltip.innerHTML = `
                <h3>${bonusTech.name}</h3>
                <p><strong>Cost:</strong> ${bonusTech.cost} Science</p>
                <p><strong>Requires:</strong> ${parentName}</p>
                <p><strong>Bonus:</strong> ${bonusTech.bonus}</p>
                <p style="margin-top: 8px; font-style: italic; color: #a09080;">Click to toggle research</p>
            `;
            
            // Position tooltip accounting for scroll and viewport bounds
            const rect = event.target.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            let left = rect.right + scrollLeft + 10;
            let top = rect.top + scrollTop;
            
            // Check if tooltip would go off screen and adjust
            const viewportWidth = window.innerWidth;
            
            // If too far right, position to left of element
            if (left + 300 > viewportWidth + scrollLeft) {
                left = rect.left + scrollLeft - 310;
            }
            
            // If too high (near top), position below element
            if (rect.top < 150) {
                top = rect.bottom + scrollTop + 10;
            }
            
            // Ensure tooltip doesn't go above the viewport
            if (top < scrollTop + 10) {
                top = scrollTop + 10;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.classList.add('show');
        }

        function toggleResearch(techId) {
            const index = researchedTechs.indexOf(techId);
            if (index > -1) {
                // Remove this tech and all techs that depend on it
                const techsToRemove = getTechsToRemove(techId);
                researchedTechs = researchedTechs.filter(id => !techsToRemove.includes(id));
                researchOrder = researchOrder.slice(0, researchedTechs.length);
            } else {
                // Add this tech and all its prerequisites
                const prereqsToAdd = getAllPrerequisites(techId);
                prereqsToAdd.forEach(prereqId => {
                    if (!researchedTechs.includes(prereqId)) {
                        researchedTechs.push(prereqId);
                        researchOrder.push(Date.now());
                    }
                });
                
                // Add the clicked tech itself if not already added
                if (!researchedTechs.includes(techId)) {
                    researchedTechs.push(techId);
                    researchOrder.push(Date.now());
                }
            }
            updateTechStates();
            updateBonusTechStates(); // Update bonus techs when main techs change
            updateOrderList();
            drawConnections();
        }

        function getAllPrerequisites(techId) {
            const visited = new Set();
            const result = [];
            
            // Get starting techs for current nation
            const startingTechs = selectedNation && nationData.startingTechs[selectedNation] 
                ? new Set(nationData.startingTechs[selectedNation]) 
                : new Set();
            
            // Find which starting techs can reach the target tech
            const reachableFromStarting = new Set();
            if (startingTechs.size > 0) {
                startingTechs.forEach(startingTech => {
                    if (canReachTech(startingTech, techId, new Set())) {
                        reachableFromStarting.add(startingTech);
                    }
                });
            }
            
            function addPrereqs(id) {
                if (visited.has(id)) return;
                visited.add(id);
                
                // Skip if this is a starting tech (already have it)
                if (startingTechs.has(id)) return;
                
                const tech = techData.techs.find(t => t.id === id);
                if (!tech) return;
                
                // First add all prerequisites of this tech
                tech.prereqs.forEach(prereqId => {
                    // Skip prerequisites that are bypassed by starting techs
                    if (!isBypassedByStartingTech(prereqId, id, reachableFromStarting)) {
                        addPrereqs(prereqId);
                    }
                });
                
                // Then add this tech (ensuring prerequisites come first)
                if (!result.includes(id)) {
                    result.push(id);
                }
            }
            
            const tech = techData.techs.find(t => t.id === techId);
            if (tech) {
                tech.prereqs.forEach(prereqId => {
                    // Skip prerequisites that are bypassed by starting techs
                    if (!isBypassedByStartingTech(prereqId, techId, reachableFromStarting)) {
                        addPrereqs(prereqId);
                    }
                });
            }
            
            return result;
        }
        
        // Helper function to check if we can reach target from source through prerequisite chain
        function canReachTech(sourceTechId, targetTechId, visited) {
            if (sourceTechId === targetTechId) return true;
            if (visited.has(sourceTechId)) return false;
            
            visited.add(sourceTechId);
            
            // Find all techs that have sourceTechId as a prerequisite
            const dependentTechs = techData.techs.filter(tech => 
                tech.prereqs.includes(sourceTechId)
            );
            
            return dependentTechs.some(tech => 
                canReachTech(tech.id, targetTechId, new Set(visited))
            );
        }
        
        // Helper function to check if a prerequisite is bypassed by starting techs
        function isBypassedByStartingTech(prereqId, targetId, reachableFromStarting) {
            // If no starting techs can reach the target, normal prerequisite rules apply
            if (reachableFromStarting.size === 0) return false;
            
            // Check if any starting tech can reach the target without going through this prerequisite
            for (const startingTech of reachableFromStarting) {
                if (canReachTechWithoutPrereq(startingTech, targetId, prereqId, new Set())) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Helper function to check if we can reach target from source without going through a specific prerequisite
        function canReachTechWithoutPrereq(sourceTechId, targetTechId, avoidPrereqId, visited) {
            if (sourceTechId === targetTechId) return true;
            if (visited.has(sourceTechId)) return false;
            if (sourceTechId === avoidPrereqId) return false; // Don't go through the prereq we're trying to avoid
            
            visited.add(sourceTechId);
            
            // Find all techs that have sourceTechId as a prerequisite
            const dependentTechs = techData.techs.filter(tech => 
                tech.prereqs.includes(sourceTechId)
            );
            
            return dependentTechs.some(tech => 
                canReachTechWithoutPrereq(tech.id, targetTechId, avoidPrereqId, new Set(visited))
            );
        }

        function getTechsToRemove(techId) {
            const toRemove = new Set([techId]);
            let changed = true;
            
            // Keep finding techs that depend on techs we're removing
            while (changed) {
                changed = false;
                researchedTechs.forEach(id => {
                    if (!toRemove.has(id)) {
                        const tech = techData.techs.find(t => t.id === id);
                        if (tech && tech.prereqs.some(prereq => toRemove.has(prereq))) {
                            toRemove.add(id);
                            changed = true;
                        }
                    }
                });
            }
            
            return Array.from(toRemove);
        }

        function updateTechStates() {
            techData.techs.forEach(tech => {
                const node = document.getElementById(tech.id);
                node.classList.remove('researched', 'available');
                
                // Remove order badge
                const existingBadge = node.querySelector('.tech-order-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                const techIndex = researchedTechs.indexOf(tech.id);
                if (techIndex > -1) {
                    node.classList.add('researched');
                    // Add order badge
                    const badge = document.createElement('div');
                    badge.className = 'tech-order-badge';
                    badge.textContent = techIndex + 1;
                    node.appendChild(badge);
                } else if (isAvailable(tech)) {
                    node.classList.add('available');
                }
            });
        }

        function isAvailable(tech) {
            return tech.prereqs.every(prereq => researchedTechs.includes(prereq));
        }

        function updateOrderList() {
            const list = document.getElementById('techOrderList');
            const totalCostElement = document.getElementById('totalCost');
            const totalLawsElement = document.getElementById('totalLaws');
            list.innerHTML = '';
            
            let totalCost = 0;
            let totalLaws = 0;
            let itemIndex = 1;
            
            // Add main techs
            researchedTechs.forEach((techId) => {
                const tech = techData.techs.find(t => t.id === techId);
                const isStartingTech = selectedNation && 
                    nationData.startingTechs[selectedNation] && 
                    nationData.startingTechs[selectedNation].includes(techId);
                
                if (!isStartingTech) {
                    totalCost += tech.cost;
                }
                
                // Count laws from this tech
                if (tech.unlocks && tech.unlocks.laws) {
                    totalLaws += tech.unlocks.laws.length;
                }
                
                const item = document.createElement('div');
                item.className = 'tech-order-item';
                
                if (isStartingTech) {
                    item.innerHTML = `
                        <span class="tech-order-number">${itemIndex}.</span>
                        <span class="tech-order-name">${tech.name}</span>
                        <span class="tech-order-cost"><span style="text-decoration: line-through; color: #888;">${tech.cost}</span> <strong style="color: #5a8a3a;">FREE</strong></span>
                    `;
                } else {
                    item.innerHTML = `
                        <span class="tech-order-number">${itemIndex}.</span>
                        <span class="tech-order-name">${tech.name}</span>
                        <span class="tech-order-cost">${tech.cost}</span>
                    `;
                }
                
                list.appendChild(item);
                itemIndex++;
            });
            
            // Add bonus techs
            researchedBonusTechs.forEach((bonusTechId) => {
                const bonusTech = techData.bonusTechs.find(t => t.id === bonusTechId);
                totalCost += bonusTech.cost;
                const item = document.createElement('div');
                item.className = 'tech-order-item';
                item.style.backgroundColor = 'rgba(180, 160, 55, 0.2)'; // Highlight bonus techs
                item.innerHTML = `
                    <span class="tech-order-number">${itemIndex}.</span>
                    <span class="tech-order-name">üíé ${bonusTech.name}</span>
                    <span class="tech-order-cost">${bonusTech.cost}</span>
                `;
                list.appendChild(item);
                itemIndex++;
            });
            
            totalCostElement.textContent = `Total Cost: ${totalCost}`;
            totalLawsElement.textContent = `Laws Available: ${totalLaws}`;
            
            // Update clear button state
            const clearButton = document.querySelector('.clear-button');
            if (researchedTechs.length === 0 && researchedBonusTechs.length === 0) {
                clearButton.classList.add('disabled');
            } else {
                clearButton.classList.remove('disabled');
            }
        }

        let connections = []; // Store line objects for cleanup
        
        function drawConnections() {
            // Remove existing connections
            connections.forEach(line => line.remove());
            connections = [];
            
            // Draw connections using Leader Line (only for main techs, not bonus techs)
            techData.techs.forEach(tech => {
                if (tech.prereqs.length > 0) {
                    const toNode = document.getElementById(tech.id);
                    if (!toNode) return;
                    
                    tech.prereqs.forEach(prereqId => {
                        const fromNode = document.getElementById(prereqId);
                        if (fromNode) {
                            // Determine line color based on research status
                            let lineColor = '#4a3426'; // default
                            if (researchedTechs.includes(prereqId) && researchedTechs.includes(tech.id)) {
                                lineColor = '#5a8a3a'; // both researched
                            } else if (researchedTechs.includes(prereqId) && isAvailable(tech)) {
                                lineColor = '#b4a037'; // prereq researched, target available
                            }
                            
                            // Create line using Leader Line
                            const line = new LeaderLine(fromNode, toNode, {
                                color: lineColor,
                                size: 2,
                                path: 'straight',
                                startSocket: 'right',
                                endSocket: 'left',
                                startSocketGravity: 100,
                                endSocketGravity: 100
                            });
                            
                            connections.push(line);
                        }
                    });
                }
            });
        }

        function showTooltip(event, tech) {
            const tooltip = document.getElementById('tooltip');
            const prereqNames = tech.prereqs.map(id => {
                const prereqTech = techData.techs.find(t => t.id === id);
                return prereqTech ? prereqTech.name : id;
            }).join(', ');
            
            let unlocksList = '';
            const hasUnlocks = tech.unlocks.units?.length > 0 || tech.unlocks.projects?.length > 0 || 
                              tech.unlocks.improvements?.length > 0 || tech.unlocks.laws?.length > 0;
            const hasBonusTechs = techData.bonusTechs.some(bonus => bonus.parent === tech.id);
            
            if (hasUnlocks || hasBonusTechs) {
                unlocksList = '<div class="unlocks-list"><h4>Unlocks:</h4><ul>';
                if (tech.unlocks.units?.length > 0) {
                    tech.unlocks.units.forEach(unit => {
                        unlocksList += `<li>Unit: ${unit}</li>`;
                    });
                }
                if (tech.unlocks.improvements?.length > 0) {
                    tech.unlocks.improvements.forEach(improvement => {
                        unlocksList += `<li>Improvement: ${improvement}</li>`;
                    });
                }
                if (tech.unlocks.laws?.length > 0) {
                    tech.unlocks.laws.forEach(law => {
                        unlocksList += `<li>Law: ${law}</li>`;
                    });
                }
                if (tech.unlocks.projects?.length > 0) {
                    tech.unlocks.projects.forEach(project => {
                        unlocksList += `<li>Project: ${project}</li>`;
                    });
                }
                if (hasBonusTechs) {
                    const bonusTechs = techData.bonusTechs.filter(bonus => bonus.parent === tech.id);
                    bonusTechs.forEach(bonusTech => {
                        unlocksList += `<li>Bonus Tech: ${bonusTech.name}</li>`;
                    });
                }
                unlocksList += '</ul></div>';
            }
            
            tooltip.innerHTML = `
                <h3>${tech.name}</h3>
                <p><strong>Cost:</strong> ${tech.cost} Science</p>
                ${tech.prereqs.length > 0 ? `<p><strong>Prerequisites:</strong> ${prereqNames}</p>` : ''}
                ${unlocksList}
                <p style="margin-top: 8px; font-style: italic; color: #a09080;">Click to toggle research</p>
            `;
            
            // Position tooltip accounting for scroll
            const rect = event.target.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            tooltip.style.left = rect.right + scrollLeft + 10 + 'px';
            tooltip.style.top = rect.top + scrollTop + 'px';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.classList.remove('show');
        }

        function shareBuild() {
            if (researchedTechs.length === 0 && !selectedNation) {
                alert('No technologies researched or nation selected to share!');
                return;
            }
            
            const urlParts = [];
            
            // Add nation if selected (using numeric index)
            if (selectedNation) {
                const nationIndex = nationLookup.findIndex(n => n === selectedNation);
                if (nationIndex !== -1) {
                    urlParts.push(`n=${nationIndex}`);
                }
            }
            
            // Add techs if any are researched
            if (researchedTechs.length > 0) {
                const techNumbers = researchedTechs.map(techId => {
                    return techData.techs.findIndex(t => t.id === techId);
                }).filter(index => index !== -1);
                urlParts.push(`t=${techNumbers.join(',')}`);
            }
            
            // Add bonus techs if any are researched
            if (researchedBonusTechs.length > 0) {
                const bonusNumbers = researchedBonusTechs.map(bonusTechId => {
                    return techData.bonusTechs.findIndex(t => t.id === bonusTechId);
                }).filter(index => index !== -1);
                urlParts.push(`b=${bonusNumbers.join(',')}`);
            }
            
            const url = urlParts.length > 0 
                ? `https://alcaras.github.io/owtt/?${urlParts.join('&')}`
                : 'https://alcaras.github.io/owtt/';
            
            // Copy to clipboard and show feedback
            const shareButton = document.querySelector('.share-button');
            const originalText = shareButton.textContent;
            
            navigator.clipboard.writeText(url).then(() => {
                // Show "Copied!" feedback
                shareButton.textContent = 'Copied!';
                shareButton.style.background = 'linear-gradient(135deg, #4a8a4a, #6ab36a)';
                
                // Also show URL temporarily
                const sharedUrl = document.getElementById('sharedUrl');
                sharedUrl.textContent = url;
                sharedUrl.classList.add('show');
                
                // Reset after 3 seconds
                setTimeout(() => {
                    shareButton.textContent = originalText;
                    shareButton.style.background = 'linear-gradient(135deg, #8b6914, #b4a037)';
                    sharedUrl.classList.remove('show');
                }, 3000);
            }).catch(() => {
                // Fallback if clipboard API fails
                shareButton.textContent = 'Copy Failed';
                setTimeout(() => {
                    shareButton.textContent = originalText;
                }, 2000);
            });
        }

        function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);
            
            // Load nation first (new format: n=index, old format: nation=NAME for backward compatibility)
            let nationParam = params.get('n');
            if (nationParam !== null) {
                const nationIndex = parseInt(nationParam);
                if (nationIndex >= 0 && nationIndex < nationLookup.length) {
                    selectedNation = nationLookup[nationIndex];
                }
            } else {
                // Backward compatibility with old format
                nationParam = params.get('nation');
                if (nationParam) {
                    selectedNation = nationParam;
                }
            }
            
            if (selectedNation) {
                const select = document.getElementById('nationSelect');
                select.value = selectedNation;
                
                // Add starting techs
                if (nationData.startingTechs[selectedNation]) {
                    const startingTechs = nationData.startingTechs[selectedNation];
                    startingTechs.forEach(techId => {
                        if (!researchedTechs.includes(techId)) {
                            researchedTechs.push(techId);
                            researchOrder.push(Date.now());
                        }
                    });
                }
            }
            
            // Load main techs (new format: t=1,2,3, old format: techs=1,2,3 for backward compatibility)
            let techsParam = params.get('t') || params.get('techs');
            if (techsParam) {
                const techNumbers = techsParam.split(',').map(n => parseInt(n)).filter(n => !isNaN(n));
                
                // Convert numbers back to tech IDs and validate
                techNumbers.forEach(techIndex => {
                    if (techIndex >= 0 && techIndex < techData.techs.length) {
                        const techId = techData.techs[techIndex].id;
                        const tech = techData.techs[techIndex];
                        
                        // Add prerequisites first
                        const prereqsToAdd = getAllPrerequisites(techId);
                        prereqsToAdd.forEach(prereqId => {
                            if (!researchedTechs.includes(prereqId)) {
                                researchedTechs.push(prereqId);
                                researchOrder.push(Date.now());
                            }
                        });
                        
                        // Add the tech itself
                        if (!researchedTechs.includes(techId)) {
                            researchedTechs.push(techId);
                            researchOrder.push(Date.now());
                        }
                    }
                });
            }
            
            // Load bonus techs (new format: b=1,2,3, old format: bonus=1,2,3 for backward compatibility)
            let bonusParam = params.get('b') || params.get('bonus');
            if (bonusParam) {
                const bonusNumbers = bonusParam.split(',').map(n => parseInt(n)).filter(n => !isNaN(n));
                
                bonusNumbers.forEach(bonusIndex => {
                    if (bonusIndex >= 0 && bonusIndex < techData.bonusTechs.length) {
                        const bonusTechId = techData.bonusTechs[bonusIndex].id;
                        if (!researchedBonusTechs.includes(bonusTechId)) {
                            researchedBonusTechs.push(bonusTechId);
                        }
                    }
                });
            }
            
            // Update displays
            initializeBonusTechs();
            updateOrderList();
        }

        function clearBuild() {
            const clearButton = document.querySelector('.clear-button');
            if (clearButton.classList.contains('disabled')) {
                return; // Don't clear if disabled
            }
            
            researchedTechs = [];
            researchOrder = [];
            researchedBonusTechs = [];
            selectedNation = '';
            
            // Reset nation selector
            const select = document.getElementById('nationSelect');
            select.value = '';
            
            initializeBonusTechs();
            updateTechStates();
            updateBonusTechStates();
            updateOrderList();
            drawConnections();
            
            // Clear URL parameters
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        function selectNation() {
            const select = document.getElementById('nationSelect');
            selectedNation = select.value;
            
            // Clear current research when changing nations
            researchedTechs = [];
            researchOrder = [];
            researchedBonusTechs = [];
            
            // Add starting techs if a nation is selected
            if (selectedNation && nationData.startingTechs[selectedNation]) {
                const startingTechs = nationData.startingTechs[selectedNation];
                startingTechs.forEach(techId => {
                    if (!researchedTechs.includes(techId)) {
                        researchedTechs.push(techId);
                        researchOrder.push(Date.now());
                    }
                });
            }
            
            // Update the bonus tech display to show/hide nation-specific bonuses
            initializeBonusTechs();
            updateTechStates();
            updateBonusTechStates();
            updateOrderList();
            drawConnections();
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            drawConnections();
        });

        // Initialize the tech tree when page loads
        window.addEventListener('load', initializeTechTree);
    </script>
</body>
</html>